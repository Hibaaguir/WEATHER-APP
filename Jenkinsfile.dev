pipeline {
    agent any
    
    parameters {
        choice(
            name: 'PYTHON_VERSION',
            choices: ['3.9', '3.10', '3.11'],
            description: 'Python version to build with'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "Checkout de la branche dev"
                git branch: 'dev', url: 'https://github.com/Hibaaguir/WEATHER-APP.git'
                bat 'git log -1 --oneline'
            }
        }
        
        stage('Setup') {
            steps {
                echo "Setup avec Python ${params.PYTHON_VERSION}"
                bat """
                    python --version
                    pip install -r requirements.txt
                """
            }
        }
        
        stage('Build') {
            parallel {
                stage('Build App') {
                    steps {
                        echo "Construction de l application"
                        bat """
                            python -m py_compile app/main.py tests/test_app.py
                        """
                    }
                }
                stage('Run Tests') {
                    steps {
                        echo "Execution des tests unitaires"
                        bat """
                            python -m unittest discover tests/ -v
                        """
                    }
                }
            }
        }
        
        stage('Run Docker') {
            steps {
                echo "Deploiement Docker"
                bat """
                    docker-compose down
                    docker-compose up -d --build
                    timeout /t 15 /nobreak
                """
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo "Tests de validation"
                bat """
                    docker-compose run --rm smoke-test
                """
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                echo "Archivage complet"
                archiveArtifacts artifacts: '**/*.py,**/*.html,**/*.css', allowEmptyArchive: true
                archiveArtifacts artifacts: 'requirements.txt,Dockerfile,docker-compose.yml', allowEmptyArchive: true
                junit '**/test-reports/*.xml'
            }
        }
    }
    
    post {
        always {
            echo "Nettoyage"
            bat 'docker-compose down'
        }
    }
}